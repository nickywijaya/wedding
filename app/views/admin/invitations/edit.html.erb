<%= stylesheet_link_tag "admin" %>

<div class="row align-items-center mb-5 mt-5">
  <div class="col-sm-1">
    <a href=<%= admin_invitations_path %> class="no-style-link">
      <span>
        <i class="bx bx-left-arrow-alt"></i>
      </span>
      Back
    </a>
  </div>
  <div class="col-sm-11">
    <h1 class="text-center">Invitation Detail</h1>
  </div>
</div>

<div class="row">
  <table class="table table-striped table-bordered table-hover">
    <thead>
      <tr>
        <th>ID</th>
        <th>Wedding</th>
        <th>Guests</th>
        <th>Attending</th>
        <th>Comment</th>
      </tr>
    </thead>
    <tbody>
      <tr>
          <td><%= @invitation.id %></td>
          <td><%= @invitation.wedding.hashtag %></td>
          <td><%= @invitation.guests&.pluck(:name)&.join(", ") %></td>
          <td><%= @invitation.fetch_attending_info%></td>
          <td><%= @invitation.comments %></td>
        </tr>
    </tbody>
  </table>
</div>

<div class="row align-items-center mb-5 mt-5">
  <div class="col-sm-12">
    <h1 class="text-center">Edit Form</h1>
  </div>
</div>

<div class="row align-items-center mb-5 mt-5">
  <%= form_with model: @invitation, url: admin_invitation_path(@invitation), method: :patch, local: true do |form| %>
    <% if @invitation.errors.any? %>
      <div class="error-messages">
        <h2><%= pluralize(@invitation.errors.count, "error") %> prohibited this invitation from being saved:</h2>
        <ul>
          <% @invitation.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <div class="form-group">
      <%= form.label :wedding_id, "Select Wedding" %>
      <%= form.select :wedding_id,
                      Weddings.all.map { |wedding| [wedding.hashtag, wedding.id] },  # This will display the hashtag in the select box and submit the wedding.id
                      { include_blank: "Select Wedding", required: true },
                      class: "form-control" %>
    </div>

    <div class="form-group">
      <%= form.label :comments, "Invitation Comment" %>
      <%= form.text_area :comments, class: "form-control", rows: 3 %>
    </div>

    <div class="form-group">
      <%= form.label :guest_ids, "Update Guests" %>
      <!-- Question mark icon with tooltip -->
      <span data-toggle="tooltip" data-placement="top" title="Select one or more guests to invite. Use Ctrl or Shift to select multiple.">
        <i class="bx bx-info-circle" style="font-size: 1.2em; cursor: pointer;"></i>
      </span>
    </div>

    <div class="form-group">
      <%= form.select :guest_ids, @guests.collect { |guest| [guest.name, guest.id] }, {}, { class: 'form-control select2', multiple: true, style: "width: 100%;" } %>
    </div>

    <div class="form-group text-center">
      <%= form.submit "Update", class: "btn btn-primary" %>
    </div>
  <% end %>
</div>

<script>
  // Initialize Select2 for the select input
  document.addEventListener('DOMContentLoaded', function() {
    const selectElements = document.querySelectorAll('.select2');

    selectElements.forEach(function(select) {
      // Allow clearing the selection
      const clearButton = document.createElement('button');
      clearButton.textContent = 'Remove All Guests';
      clearButton.classList.add('btn', 'btn-primary', 'center');  // Add the classes

      // Prevent form submission if 'No' is clicked in the confirmation prompt
      clearButton.addEventListener('click', function(event) {
        const confirmClear = confirm("Are you sure you want to remove all guests?");

        if (!confirmClear) {
          event.preventDefault();  // Prevent form submission
          return; // Exit function if user clicked "No"
        }

        // If confirmed, clear the selection
        select.selectedIndex = -1;  // Clear the selection
      });

      select.parentNode.insertBefore(clearButton, select.nextSibling);
    });
  });
</script>
